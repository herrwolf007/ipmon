{% extends "layout.html" %}

{% block content %}

<section class="hero-body">
  <div class="container has-text-centered">
    <nav class="level">
      <div class="level-item">
        <div>
          <p class="heading">Total Hosts</p>
          <p class="title has-text-primary">{{ num_hosts }}</p>
        </div>
      </div>
      <div class="level-item has-text-centered">
        <div>
          <p class="heading">Available Hosts</p>
          <p class="title has-text-success">{{ num_up }}</p>
        </div>
      </div>
      <div class="level-item has-text-centered">
        <div>
          <p class="heading">Unavailable Hosts</p>
          <p class="title has-text-danger">{{ num_down }}</p>
        </div>
      </div>
    </nav>
  </div>
</section>

<section class="hero-body">
  <div class="container has-text-centered">
    <progress class="progress is-large is-info" max="100" id="progress">50%</progress>
    <table class="table is-fullwidth is-hoverable is-striped" id="ip_status">
      <!-- Datatable Generated Here -->
    </table>
  </div>
</section>

<!-- Poll Hosts -->
<script>
  async function updateTable() {
    await $.ajax({
      url: '/pollHosts',
      type: 'GET',
      success: function (response) {
        var json_data = JSON.parse(response)
        var json = {
          "columns": [
            { "data": "hostname", "title": "Hostname" },
            { "data": "ip_address", "title": "IP Address" },
            { "data": "last_poll", "title": "Last Poll" },
            { "data": "status", "title": "Status" }
          ],
          "data": json_data
        }

        if ($.fn.DataTable.isDataTable('#ip_status')) {
          $('#ip_status').DataTable().destroy();
        }

        var table = $('#ip_status').DataTable({
          data: json.data,
          columns: json.columns,
          paging: false,
          stateSave: true,
          'rowCallback': function (row, data, index) {
            var this_row = $(row).find('td:eq(3)')
            this_row.empty();
            if (data['status'] == 'Down') {
              this_row.addClass("has-text-danger");
              this_row.append('<i class="fas fa-arrow-circle-down"></i>');
            } else {
              this_row.addClass("has-text-success");
              this_row.append('<i class="fas fa-arrow-circle-up"></i>');
            }
          }
        })
      }
    });
  }

  // Show progress bar until datatable loads
  // Update datatable at interval of {{ poll_time }} seconds
  $(document).ready(async function () {
    await updateTable();
    await $("#progress").hide();
    setInterval(updateTable, {{ poll_time }});
  });

</script>

{% endblock %}